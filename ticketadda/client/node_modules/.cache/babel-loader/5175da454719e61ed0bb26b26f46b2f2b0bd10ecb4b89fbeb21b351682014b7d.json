{"ast":null,"code":"\"use strict\";\n\n/*\n * Copyright 2018, 2019 IBM All Rights Reserved.\n *\n * SPDX-License-Identifier: Apache-2.0\n */\nvar __createBinding = this && this.__createBinding || (Object.create ? function (o, m, k, k2) {\n  if (k2 === undefined) k2 = k;\n  Object.defineProperty(o, k2, {\n    enumerable: true,\n    get: function () {\n      return m[k];\n    }\n  });\n} : function (o, m, k, k2) {\n  if (k2 === undefined) k2 = k;\n  o[k2] = m[k];\n});\nvar __setModuleDefault = this && this.__setModuleDefault || (Object.create ? function (o, v) {\n  Object.defineProperty(o, \"default\", {\n    enumerable: true,\n    value: v\n  });\n} : function (o, v) {\n  o[\"default\"] = v;\n});\nvar __importStar = this && this.__importStar || function (mod) {\n  if (mod && mod.__esModule) return mod;\n  var result = {};\n  if (mod != null) for (var k in mod) if (k !== \"default\" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);\n  __setModuleDefault(result, mod);\n  return result;\n};\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.RoundRobinQueryHandler = void 0;\nconst fabricerror_1 = require(\"../../errors/fabricerror\");\nconst util = __importStar(require(\"util\"));\nconst Logger = __importStar(require(\"../../logger\"));\nconst logger = Logger.getLogger('RoundRobinQueryHandler');\nclass RoundRobinQueryHandler {\n  constructor(peers) {\n    this.currentPeerIndex = 0;\n    logger.debug('constructor: peers=%j', peers.map(peer => peer.name));\n    this.peers = peers;\n  }\n  async evaluate(query) {\n    const method = 'evaluate';\n    logger.debug('%s - start', method);\n    const startPeerIndex = this.currentPeerIndex;\n    this.currentPeerIndex = (this.currentPeerIndex + 1) % this.peers.length;\n    const errorMessages = [];\n    for (let i = 0; i < this.peers.length; i++) {\n      const peerIndex = (startPeerIndex + i) % this.peers.length;\n      const peer = this.peers[peerIndex];\n      logger.debug('%s - sending to peer %s', method, peer.name);\n      const results = await query.evaluate([peer]);\n      const result = results[peer.name];\n      if (result instanceof Error) {\n        errorMessages.push(result.toString());\n      } else {\n        if (result.isEndorsed) {\n          logger.debug('%s - return peer response status: %s', method, result.status);\n          return result.payload;\n        } else {\n          logger.debug('%s - throw peer response status: %s message: %s', method, result.status, result.message);\n          const responseError = Object.assign(new Error(result.message), result);\n          throw responseError;\n        }\n      }\n    }\n    const message = util.format('Query failed. Errors: %j', errorMessages);\n    const error = new fabricerror_1.FabricError(message);\n    logger.error('evaluate:', error);\n    throw error;\n  }\n}\nexports.RoundRobinQueryHandler = RoundRobinQueryHandler;","map":{"version":3,"names":["fabricerror_1","require","util","__importStar","Logger","logger","getLogger","RoundRobinQueryHandler","constructor","peers","currentPeerIndex","debug","map","peer","name","evaluate","query","method","startPeerIndex","length","errorMessages","i","peerIndex","results","result","Error","push","toString","isEndorsed","status","payload","message","responseError","Object","assign","format","error","FabricError","exports"],"sources":["../../../src/impl/query/roundrobinqueryhandler.ts"],"sourcesContent":[null],"mappings":";;AAAA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAMA,MAAAA,aAAA,GAAAC,OAAA;AAMA,MAAAC,IAAA,GAAAC,YAAA,CAAAF,OAAA;AAEA,MAAAG,MAAA,GAAAD,YAAA,CAAAF,OAAA;AACA,MAAMI,MAAM,GAAGD,MAAM,CAACE,SAAS,CAAC,wBAAwB,CAAC;AAEzD,MAAaC,sBAAsB;EAIlCC,YAAYC,KAAiB;IAFrB,KAAAC,gBAAgB,GAAG,CAAC;IAG3BL,MAAM,CAACM,KAAK,CAAC,uBAAuB,EAAEF,KAAK,CAACG,GAAG,CAAEC,IAAI,IAAKA,IAAI,CAACC,IAAI,CAAC,CAAC;IACrE,IAAI,CAACL,KAAK,GAAGA,KAAK;EACnB;EAEA,MAAMM,QAAQA,CAACC,KAAY;IAC1B,MAAMC,MAAM,GAAG,UAAU;IACzBZ,MAAM,CAACM,KAAK,CAAC,YAAY,EAAEM,MAAM,CAAC;IAElC,MAAMC,cAAc,GAAG,IAAI,CAACR,gBAAgB;IAC5C,IAAI,CAACA,gBAAgB,GAAG,CAAC,IAAI,CAACA,gBAAgB,GAAG,CAAC,IAAI,IAAI,CAACD,KAAK,CAACU,MAAM;IACvE,MAAMC,aAAa,GAAG,EAAE;IAExB,KAAK,IAAIC,CAAC,GAAG,CAAC,EAAEA,CAAC,GAAG,IAAI,CAACZ,KAAK,CAACU,MAAM,EAAEE,CAAC,EAAE,EAAE;MAC3C,MAAMC,SAAS,GAAG,CAACJ,cAAc,GAAGG,CAAC,IAAI,IAAI,CAACZ,KAAK,CAACU,MAAM;MAE1D,MAAMN,IAAI,GAAG,IAAI,CAACJ,KAAK,CAACa,SAAS,CAAC;MAClCjB,MAAM,CAACM,KAAK,CAAC,yBAAyB,EAAEM,MAAM,EAAEJ,IAAI,CAACC,IAAI,CAAC;MAE1D,MAAMS,OAAO,GAAG,MAAMP,KAAK,CAACD,QAAQ,CAAC,CAACF,IAAI,CAAC,CAAC;MAC5C,MAAMW,MAAM,GAAGD,OAAO,CAACV,IAAI,CAACC,IAAI,CAAC;MACjC,IAAIU,MAAM,YAAYC,KAAK,EAAE;QAC5BL,aAAa,CAACM,IAAI,CAACF,MAAM,CAACG,QAAQ,EAAE,CAAC;OACrC,MAAM;QACN,IAAIH,MAAM,CAACI,UAAU,EAAE;UACtBvB,MAAM,CAACM,KAAK,CAAC,sCAAsC,EAAEM,MAAM,EAAEO,MAAM,CAACK,MAAM,CAAC;UAC3E,OAAOL,MAAM,CAACM,OAAO;SACrB,MAAM;UACNzB,MAAM,CAACM,KAAK,CAAC,iDAAiD,EAAEM,MAAM,EAAEO,MAAM,CAACK,MAAM,EAAEL,MAAM,CAACO,OAAO,CAAC;UACtG,MAAMC,aAAa,GAAGC,MAAM,CAACC,MAAM,CAAC,IAAIT,KAAK,CAACD,MAAM,CAACO,OAAO,CAAC,EAAEP,MAAM,CAAC;UACtE,MAAMQ,aAAa;;;;IAKtB,MAAMD,OAAO,GAAG7B,IAAI,CAACiC,MAAM,CAAC,0BAA0B,EAAEf,aAAa,CAAC;IACtE,MAAMgB,KAAK,GAAG,IAAIpC,aAAA,CAAAqC,WAAW,CAACN,OAAO,CAAC;IACtC1B,MAAM,CAAC+B,KAAK,CAAC,WAAW,EAAEA,KAAK,CAAC;IAChC,MAAMA,KAAK;EACZ;;AA3CDE,OAAA,CAAA/B,sBAAA,GAAAA,sBAAA"},"metadata":{},"sourceType":"script","externalDependencies":[]}