{"ast":null,"code":"\"use strict\";\n\n/*\n Copyright 2019 IBM All Rights Reserved.\n\n SPDX-License-Identifier: Apache-2.0\n*/\nvar __createBinding = this && this.__createBinding || (Object.create ? function (o, m, k, k2) {\n  if (k2 === undefined) k2 = k;\n  Object.defineProperty(o, k2, {\n    enumerable: true,\n    get: function () {\n      return m[k];\n    }\n  });\n} : function (o, m, k, k2) {\n  if (k2 === undefined) k2 = k;\n  o[k2] = m[k];\n});\nvar __setModuleDefault = this && this.__setModuleDefault || (Object.create ? function (o, v) {\n  Object.defineProperty(o, \"default\", {\n    enumerable: true,\n    value: v\n  });\n} : function (o, v) {\n  o[\"default\"] = v;\n});\nvar __importStar = this && this.__importStar || function (mod) {\n  if (mod && mod.__esModule) return mod;\n  var result = {};\n  if (mod != null) for (var k in mod) if (k !== \"default\" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);\n  __setModuleDefault(result, mod);\n  return result;\n};\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.loadFromConfig = void 0;\nconst fs = __importStar(require(\"fs\"));\nconst fabric_common_1 = require(\"fabric-common\");\nconst logger = fabric_common_1.Utils.getLogger('NetworkConfig');\n/* eslint-disable @typescript-eslint/no-unsafe-assignment */\n/* eslint-disable @typescript-eslint/no-unsafe-member-access */\n/**\n * Configures a client object using a supplied connection profile JSON object.\n * @private\n */\n// eslint-disable-next-line @typescript-eslint/no-explicit-any\nasync function loadFromConfig(client) {\n  let config = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};\n  const method = 'loadFromConfig';\n  logger.debug('%s - start', method);\n  // create peers\n  if (config.peers) {\n    for (const peerName in config.peers) {\n      await buildPeer(client, peerName, config.peers[peerName], config);\n    }\n  }\n  // create orderers\n  if (config.orderers) {\n    for (const ordererName in config.orderers) {\n      await buildOrderer(client, ordererName, config.orderers[ordererName]);\n    }\n  }\n  // build channels\n  if (config.channels) {\n    for (const channelName in config.channels) {\n      await buildChannel(client, channelName, config.channels[channelName]);\n    }\n  }\n  logger.debug('%s - end', method);\n}\nexports.loadFromConfig = loadFromConfig;\n// eslint-disable-next-line @typescript-eslint/no-explicit-any\nfunction buildChannel(client, channelName, channelConfig) {\n  const method = 'buildChannel';\n  logger.debug('%s - start - %s', method, channelName);\n  // this will add the channel to the client instance\n  const channel = client.getChannel(channelName);\n  const peers = channelConfig.peers;\n  if (peers) {\n    const peerNames = Array.isArray(peers) ? peers : Object.keys(peers);\n    peerNames.forEach(peerName => {\n      const peer = client.getEndorser(peerName);\n      channel.addEndorser(peer);\n      logger.debug('%s - added endorsing peer :: %s', method, peer.name);\n    });\n  } else {\n    logger.debug('%s - no peers in config', method);\n  }\n  if (channelConfig.orderers) {\n    channelConfig.orderers.forEach(ordererName => {\n      const orderer = client.getCommitter(ordererName);\n      channel.addCommitter(orderer);\n      logger.debug('%s - added orderer :: %s', method, orderer.name);\n    });\n  } else {\n    logger.debug('%s - no orderers in config', method);\n  }\n  return Promise.resolve();\n}\n// eslint-disable-next-line @typescript-eslint/no-explicit-any\nasync function buildOrderer(client, ordererName, ordererConfig) {\n  const method = 'buildOrderer';\n  logger.debug('%s - start - %s', method, ordererName);\n  const mspid = ordererConfig.mspid;\n  const options = await buildOptions(ordererConfig);\n  const endpoint = client.newEndpoint(options);\n  logger.debug('%s - about to connect to committer %s url:%s mspid:%s', method, ordererName, ordererConfig.url, mspid);\n  // since the client saves the orderer, no need to save here\n  const orderer = client.getCommitter(ordererName, mspid);\n  try {\n    await orderer.connect(endpoint);\n    logger.debug('%s - connected to committer %s url:%s', method, ordererName, ordererConfig.url);\n  } catch (error) {\n    logger.info('%s - Unable to connect to the committer %s due to %s', method, ordererName, error);\n  }\n}\n// eslint-disable-next-line @typescript-eslint/no-explicit-any\nasync function buildPeer(client, peerName, peerConfig, config) {\n  const method = 'buildPeer';\n  logger.debug('%s - start - %s', method, peerName);\n  const mspid = findPeerMspid(peerName, config);\n  const options = await buildOptions(peerConfig);\n  const endpoint = client.newEndpoint(options);\n  logger.debug('%s - about to connect to endorser %s url:%s mspid:%s', method, peerName, peerConfig.url, mspid);\n  // since this adds to the clients list, no need to save\n  const peer = client.getEndorser(peerName, mspid);\n  try {\n    await peer.connect(endpoint);\n    logger.debug('%s - connected to endorser %s url:%s', method, peerName, peerConfig.url);\n  } catch (error) {\n    logger.info('%s - Unable to connect to the endorser %s due to %s', method, peerName, error);\n  }\n}\n// eslint-disable-next-line @typescript-eslint/no-explicit-any\nfunction findPeerMspid(name, config) {\n  const method = 'findPeerMspid';\n  logger.debug('%s - start for %s', method, name);\n  let mspid;\n  here: for (const orgName in config.organizations) {\n    const org = config.organizations[orgName];\n    for (const peer of org.peers) {\n      logger.debug('%s - checking peer %s in org %s', method, peer, orgName);\n      if (peer === name) {\n        mspid = org.mspid;\n        logger.debug('%s - found mspid %s for %s', method, mspid, name);\n        break here;\n      }\n    }\n  }\n  return mspid;\n}\n// eslint-disable-next-line @typescript-eslint/no-explicit-any\nasync function buildOptions(endpointConfig) {\n  const method = 'buildOptions';\n  logger.debug(`${method} - start`);\n  const options = {\n    url: endpointConfig.url\n  };\n  const pem = await getPEMfromConfig(endpointConfig.tlsCACerts);\n  if (pem) {\n    options.pem = pem;\n  }\n  Object.assign(options, endpointConfig.grpcOptions);\n  if (options['request-timeout'] && !options.requestTimeout) {\n    options.requestTimeout = options['request-timeout'];\n  }\n  return options;\n}\nasync function getPEMfromConfig(config) {\n  let result;\n  if (config) {\n    if (config.pem) {\n      // cert value is directly in the configuration\n      result = config.pem;\n    } else if (config.path) {\n      // cert value is in a file\n      const data = await fs.promises.readFile(config.path);\n      result = Buffer.from(data).toString();\n      result = fabric_common_1.Utils.normalizeX509(result);\n    }\n  }\n  return result;\n}","map":{"version":3,"names":["fs","__importStar","require","fabric_common_1","logger","Utils","getLogger","loadFromConfig","client","config","arguments","length","undefined","method","debug","peers","peerName","buildPeer","orderers","ordererName","buildOrderer","channels","channelName","buildChannel","exports","channelConfig","channel","getChannel","peerNames","Array","isArray","Object","keys","forEach","peer","getEndorser","addEndorser","name","orderer","getCommitter","addCommitter","Promise","resolve","ordererConfig","mspid","options","buildOptions","endpoint","newEndpoint","url","connect","error","info","peerConfig","findPeerMspid","here","orgName","organizations","org","endpointConfig","pem","getPEMfromConfig","tlsCACerts","assign","grpcOptions","requestTimeout","result","path","data","promises","readFile","Buffer","from","toString","normalizeX509"],"sources":["../../../src/impl/ccp/networkconfig.ts"],"sourcesContent":[null],"mappings":"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"},"metadata":{},"sourceType":"script","externalDependencies":[]}