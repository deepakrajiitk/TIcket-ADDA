{"ast":null,"code":"\"use strict\";\n\n/*\n * Copyright 2020 IBM All Rights Reserved.\n *\n * SPDX-License-Identifier: Apache-2.0\n */\nvar __createBinding = this && this.__createBinding || (Object.create ? function (o, m, k, k2) {\n  if (k2 === undefined) k2 = k;\n  Object.defineProperty(o, k2, {\n    enumerable: true,\n    get: function () {\n      return m[k];\n    }\n  });\n} : function (o, m, k, k2) {\n  if (k2 === undefined) k2 = k;\n  o[k2] = m[k];\n});\nvar __setModuleDefault = this && this.__setModuleDefault || (Object.create ? function (o, v) {\n  Object.defineProperty(o, \"default\", {\n    enumerable: true,\n    value: v\n  });\n} : function (o, v) {\n  o[\"default\"] = v;\n});\nvar __importStar = this && this.__importStar || function (mod) {\n  if (mod && mod.__esModule) return mod;\n  var result = {};\n  if (mod != null) for (var k in mod) if (k !== \"default\" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);\n  __setModuleDefault(result, mod);\n  return result;\n};\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.QueryImpl = void 0;\nconst gatewayutils_1 = require(\"../gatewayutils\");\nconst Logger = __importStar(require(\"../../logger\"));\nconst logger = Logger.getLogger('Query');\n/**\n * @private\n */\nclass QueryImpl {\n  /**\n   * Builds a Query instance to send and then work with the results returned\n   * by the fabric-common/Query.\n   * @param {module:fabric-common.Query} query - The query instance of the proposal\n   * @returns {Object} options - options to be used when sending the request to\n   * fabric-common service endpoint {Endorser} peer.\n   */\n  constructor(query) {\n    let options = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};\n    this.query = query;\n    this.requestTimeout = 3000; // default 3 seconds\n    if (options.timeout && Number.isInteger(options.timeout)) {\n      this.requestTimeout = options.timeout * 1000; // need ms;\n    }\n  }\n  /**\n   * Sends a signed proposal to the specified peers. The peer endorsment\n   * responses are\n   * @param {Endorser[]} peers - The peers to query\n   * @returns {Object.<String, (QueryResponse | Error)>} Object with peer name keys and associated values that are either\n   * QueryResponse objects or Error objects.\n   */\n  async evaluate(peers) {\n    const method = 'evaluate';\n    logger.debug('%s - start', method);\n    const results = {};\n    try {\n      const responses = await this.query.send({\n        targets: peers,\n        requestTimeout: this.requestTimeout\n      });\n      if (responses) {\n        if (responses.errors) {\n          for (const resultError of responses.errors) {\n            results[resultError.connection.name] = resultError;\n            logger.debug('%s - problem with query to peer %s error:%s', method, resultError.connection.name, resultError);\n          }\n        }\n        if (responses.responses) {\n          for (const peerResponse of responses.responses) {\n            if (peerResponse.response) {\n              const response = newQueryResponse(peerResponse);\n              results[peerResponse.connection.name] = response;\n              logger.debug('%s - have results - peer: %s with status:%s', method, peerResponse.connection.name, response.status);\n            }\n          }\n        }\n        // check to be sure we got results for each peer requested\n        for (const peer of peers) {\n          if (!results[peer.name]) {\n            logger.error('%s - no results for peer: %s', method, peer.name);\n            results[peer.name] = new Error('Missing response from peer');\n          }\n        }\n      } else {\n        throw Error('No responses returned for query');\n      }\n    } catch (error) {\n      // if we get an error, return this error for each peer\n      for (const peer of peers) {\n        results[peer.name] = error;\n        logger.error('%s - problem with query to peer %s error:%s', method, peer.name, error);\n      }\n    }\n    logger.debug('%s - end', method);\n    return results;\n  }\n}\nexports.QueryImpl = QueryImpl;\nfunction newQueryResponse(endorseResponse) {\n  const isEndorsed = endorseResponse.endorsement ? true : false;\n  const payload = isEndorsed ? (0, gatewayutils_1.asBuffer)((0, gatewayutils_1.getTransactionResponse)(endorseResponse).payload) : endorseResponse.response.payload;\n  return {\n    isEndorsed,\n    message: endorseResponse.response.message,\n    payload,\n    status: endorseResponse.response.status\n  };\n}","map":{"version":3,"names":["gatewayutils_1","require","Logger","__importStar","logger","getLogger","QueryImpl","constructor","query","options","arguments","length","undefined","requestTimeout","timeout","Number","isInteger","evaluate","peers","method","debug","results","responses","send","targets","errors","resultError","connection","name","peerResponse","response","newQueryResponse","status","peer","error","Error","exports","endorseResponse","isEndorsed","endorsement","payload","asBuffer","getTransactionResponse","message"],"sources":["../../../src/impl/query/query.ts"],"sourcesContent":[null],"mappings":"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"},"metadata":{},"sourceType":"script","externalDependencies":[]}